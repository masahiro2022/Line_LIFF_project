<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç¼ºå¤±ç¨½æ ¸</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 1.5rem;
      background-color: #f5f5f5;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: #333;
    }
    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.3rem;
      color: #555;
    }
    select, textarea, button {
      width: 100%;
      padding: 0.6rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      margin-top: 1.5rem;
      background-color: #06c755;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #04a04f;
    }
    #debug {
      margin-top: 2rem;
      max-height: 250px;
      overflow-y: auto;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    .log-entry {
      margin-bottom: 0.8rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px dashed #ddd;
    }
    .log-entry.success .timestamp { color: green; }
    .log-entry.error .timestamp { color: red; }
    .log-entry.info .timestamp { color: #0077cc; }
  </style>
</head>
<body>
  <h1>ç¼ºå¤±ç¨½æ ¸è¡¨å–®</h1>
  
  <label for="departmentSelect">éƒ¨é–€</label>
  <select id="departmentSelect">
    <option>è¼‰å…¥ä¸­...</option>
  </select>

  <label for="nameSelect">å§“å</label>
  <select id="nameSelect">
    <option>è¼‰å…¥ä¸­...</option>
  </select>

  <label for="contentInput">ç¼ºå¤±å…§å®¹</label>
  <textarea id="contentInput" rows="4" placeholder="è«‹è¼¸å…¥ç¼ºå¤±å…§å®¹..."></textarea>

  <button id="submitButton">é€å‡ºè¡¨å–®</button>

  <div id="debug">
    <strong>ğŸ“‹ Debug è¨Šæ¯ï¼š</strong>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxUKFblGP1fv6Io0Q3KOZw-Bv2ljw9GRuNBMmkP81v5he6F51U1vuff7ckKnSg0RSAnDA/exec"; // ğŸ” æ›¿æ›ç‚ºä½ çš„ Web App URL

    async function initLiff() {
      try {
        await liff.init({ liffId: "2007299608-oa1mk1WJ" }); // ğŸ” æ›¿æ›ç‚ºä½ çš„ LIFF ID
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          getUserAndLoadOptions();
        }
      } catch (e) {
        updateDebug("âŒ LIFF åˆå§‹åŒ–å¤±æ•—", e.message, "error");
      }
    }

    async function getUserAndLoadOptions() {
      try {
        const profile = await liff.getProfile();
        const email = liff.getDecodedIDToken()?.email;
        updateDebug("âœ… ä½¿ç”¨è€…è³‡è¨Šè¼‰å…¥æˆåŠŸ", `å§“åï¼š${profile.displayName}\nEmailï¼š${email}`, "success");

        window.auditUser = {
          name: profile.displayName,
          email
        };

        loadFormOptions();
      } catch (e) {
        updateDebug("âŒ ä½¿ç”¨è€…è³‡è¨Šå–å¾—å¤±æ•—", e.message, "error");
      }
    }

    function loadFormOptions() {
      updateDebug("ğŸ“¥ è¼‰å…¥éƒ¨é–€èˆ‡å§“åé¸é …ä¸­...", "", "info");

      const formData = new FormData();
      formData.append("action", "getAuditFormOptions");

      $.ajax({
        url: GAS_URL,
        method: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: (res) => {
          try {
            const data = typeof res === "string" ? JSON.parse(res) : res;
            if (data.status === "success") {
              populateDropdown("departmentSelect", data.departments);
              populateDropdown("nameSelect", data.names);
              updateDebug("âœ… è¡¨å–®é¸é …è¼‰å…¥å®Œæˆ", "", "success");
            } else {
              updateDebug("âŒ è¡¨å–®é¸é …è¼‰å…¥éŒ¯èª¤", data.message, "error");
            }
          } catch (err) {
            updateDebug("âŒ JSON æ ¼å¼éŒ¯èª¤", err.message, "error");
          }
        },
        error: (xhr, status, error) => {
          updateDebug("âŒ AJAX éŒ¯èª¤", `ç‹€æ…‹ï¼š${status}, éŒ¯èª¤ï¼š${error}`, "error");
        }
      });
    }

    function populateDropdown(id, options) {
      const select = document.getElementById(id);
      select.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join("");
    }

    function submitForm() {
      const name = document.getElementById("nameSelect").value;
      const department = document.getElementById("departmentSelect").value;
      const content = document.getElementById("contentInput").value;
      const email = window.auditUser?.email;

      if (!content) {
        updateDebug("âš ï¸ ç¼ºå¤±å…§å®¹ä¸å¾—ç‚ºç©º", "", "error");
        return;
      }

      const formData = new FormData();
      formData.append("action", "submitAudit");
      formData.append("name", name);
      formData.append("department", department);
      formData.append("content", content);
      formData.append("email", email);

      updateDebug("ğŸ“¤ è¡¨å–®é€å‡ºä¸­...", "", "info");

      $.ajax({
        url: GAS_URL,
        method: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: (res) => {
          try {
            const data = typeof res === "string" ? JSON.parse(res) : res;
            updateDebug(data.message, "", data.status === "success" ? "success" : "error");
          } catch (err) {
            updateDebug("âŒ JSON è§£æå¤±æ•—", err.message, "error");
          }
        },
        error: (xhr, status, error) => {
          updateDebug("âŒ è¡¨å–®é€å‡ºå¤±æ•—", `ç‹€æ…‹ï¼š${status}, éŒ¯èª¤ï¼š${error}`, "error");
        }
      });
    }

    function updateDebug(status, details = "", type = "info") {
      const timestamp = new Date().toLocaleTimeString();
      const log = document.createElement("div");
      log.className = `log-entry ${type}`;
      log.innerHTML = `  
        <div class="timestamp">[${timestamp}] ${status}</div>
        ${details ? `<div style="margin-top: 0.3rem; color:#666;">${typeof details === 'string' ? details : JSON.stringify(details, null, 2)}</div>` : ""}`;
      const debugPanel = document.getElementById("debug");
      debugPanel.appendChild(log);
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    document.getElementById("submitButton").addEventListener("click", submitForm);
    initLiff();
  </script>
</body>
</html>
